<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goobert Stats Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #22222e;
            --accent: #00d4ff;
            --accent-dim: #0099bb;
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --border: #2a2a3a;
            --success: #00ff88;
            --warning: #ffaa00;
            --error: #ff4466;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent);
        }

        .header .subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-top: 4px;
        }

        .refresh-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        @media (max-width: 1200px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card {
            text-align: center;
            padding: 24px 20px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-value.accent {
            color: var(--accent);
        }

        .stat-value.success {
            color: var(--success);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .stat-sublabel {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            opacity: 0.7;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
        }

        td {
            color: var(--text-primary);
        }

        tr:hover {
            background: var(--bg-hover);
        }

        .file-name {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-image {
            background: var(--accent-dim);
            color: white;
        }

        .badge-video {
            background: var(--success);
            color: black;
        }

        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .tab:hover {
            background: var(--bg-hover);
        }

        .tab.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .comparison-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 32px;
            padding: 24px;
        }

        .comparison-item {
            text-align: center;
        }

        .comparison-vs {
            font-size: 24px;
            color: var(--text-muted);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .event-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .event-skip { background: var(--warning); color: black; }
        .event-loop { background: var(--accent); color: black; }
        .event-fullscreen { background: #9966ff; color: white; }

        .highlight-row {
            background: rgba(0, 212, 255, 0.05);
        }

        .copy-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 8px;
        }

        .copy-btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .copy-btn.copied {
            background: var(--success);
            color: black;
        }

        .path-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .path-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 400px;
        }

        .open-btn {
            background: var(--success);
            border: none;
            color: black;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 4px;
        }

        .open-btn:hover {
            background: #00cc77;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--accent);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Goobert Stats Dashboard</h1>
            <div class="subtitle">Real-time watch statistics from your video wall</div>
        </div>
        <button class="refresh-btn" onclick="refreshAll()">Refresh Data</button>
    </div>

    <div class="container">
        <!-- Summary Stats -->
        <div class="section">
            <div class="grid grid-4" id="summary-stats">
                <div class="card stat-card">
                    <div class="stat-value accent" id="real-time">--</div>
                    <div class="stat-label">Real Elapsed Time</div>
                    <div class="stat-sublabel">Actual time spent watching</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="accumulated-time">--</div>
                    <div class="stat-label">Accumulated Watch Time</div>
                    <div class="stat-sublabel">Sum of all cell playback</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value success" id="parallelism">--</div>
                    <div class="stat-label">Parallelism Factor</div>
                    <div class="stat-sublabel">Avg cells playing at once</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="files-tracked">--</div>
                    <div class="stat-label">Files Tracked</div>
                    <div class="stat-sublabel">Unique media files</div>
                </div>
            </div>
        </div>

        <!-- Today's Stats -->
        <div class="section">
            <h2 class="section-title">Today's Activity</h2>
            <div class="grid grid-4">
                <div class="card stat-card">
                    <div class="stat-value accent" id="today-real">--</div>
                    <div class="stat-label">Real Time Today</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="today-accumulated">--</div>
                    <div class="stat-label">Accumulated Today</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="today-sessions">--</div>
                    <div class="stat-label">Sessions Today</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="avg-session">--</div>
                    <div class="stat-label">Avg Session Length</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="section">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Hourly Distribution</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Daily Distribution</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline Chart -->
        <div class="section">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Activity Timeline (Last 30 Days)</span>
                </div>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Peak Stats -->
        <div class="section">
            <div class="grid grid-4">
                <div class="card stat-card">
                    <div class="stat-value" id="peak-hour">--</div>
                    <div class="stat-label">Peak Hour</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="peak-day">--</div>
                    <div class="stat-label">Peak Day</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="total-skips">--</div>
                    <div class="stat-label">Total Skips</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="total-screenshots">--</div>
                    <div class="stat-label">Screenshots</div>
                </div>
            </div>
        </div>

        <!-- Completion & File Type Stats -->
        <div class="section">
            <h2 class="section-title">Content Analysis</h2>
            <div class="grid grid-4">
                <div class="card stat-card">
                    <div class="stat-value success" id="full-watch">--</div>
                    <div class="stat-label">Fully Watched (>90%)</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="partial-watch">--</div>
                    <div class="stat-label">Partial Watch</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" style="color: var(--warning)" id="skipped-files">--</div>
                    <div class="stat-label">Skipped (<10%)</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value accent" id="avg-completion">--</div>
                    <div class="stat-label">Avg Completion %</div>
                </div>
            </div>
        </div>

        <!-- File Type & Concurrent Stats -->
        <div class="section">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">File Type Breakdown</span>
                    </div>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="fileTypeChart"></canvas>
                    </div>
                    <div class="grid grid-2" style="margin-top: 16px;">
                        <div class="stat-card" style="padding: 12px;">
                            <div class="stat-value" style="font-size: 20px; color: var(--success)" id="video-time">--</div>
                            <div class="stat-label">Videos (<span id="video-count">0</span> files)</div>
                        </div>
                        <div class="stat-card" style="padding: 12px;">
                            <div class="stat-value" style="font-size: 20px; color: var(--accent)" id="image-time">--</div>
                            <div class="stat-label">Images (<span id="image-count">0</span> files)</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Concurrent Cell Usage</span>
                    </div>
                    <div class="stat-card" style="padding: 24px;">
                        <div class="stat-value accent" id="avg-concurrent">--</div>
                        <div class="stat-label">Average Cells Playing</div>
                    </div>
                    <div class="table-container" style="max-height: 200px; overflow-y: auto;">
                        <table id="cell-usage-table">
                            <thead>
                                <tr>
                                    <th>Cell</th>
                                    <th>Sessions</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Skip Analysis -->
        <div class="section">
            <h2 class="section-title">Skip Analysis</h2>
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Skip Position Heatmap</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="skipHeatmapChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Skip Types</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="skipTypesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Distribution -->
        <div class="section">
            <h2 class="section-title">Session Analysis</h2>
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Session Length Distribution</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="sessionDistChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Monthly Trend</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Trend -->
        <div class="section">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Weekly Watch Time Trend (Last 12 Weeks)</span>
                </div>
                <div class="chart-container">
                    <canvas id="weeklyTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Favorites Section -->
        <div class="section">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Favorites</span>
                </div>
                <div class="table-container">
                    <table id="favorites-table">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Watch Time</th>
                                <th>Plays</th>
                                <th>Type</th>
                                <th>Added</th>
                                <th>Path</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div id="no-favorites" style="text-align: center; padding: 24px; color: var(--text-muted);">
                        No favorites yet. Add favorites from the Top Files table.
                    </div>
                </div>
            </div>
        </div>

        <!-- Tables Row -->
        <div class="section">
            <div class="grid grid-2">
                <!-- Top Files -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Most Watched Files</span>
                    </div>
                    <div class="table-container">
                        <table id="top-files-table">
                            <thead>
                                <tr>
                                    <th>File</th>
                                    <th>Time</th>
                                    <th>Plays</th>
                                    <th>Skips</th>
                                    <th>Loops</th>
                                    <th>Avg %</th>
                                    <th>Type</th>
                                    <th>Path</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Directories -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Top Directories</span>
                    </div>
                    <div class="table-container">
                        <table id="directories-table">
                            <thead>
                                <tr>
                                    <th>Directory</th>
                                    <th>Watch Time</th>
                                    <th>Files</th>
                                    <th>Path</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Sessions -->
        <div class="section">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Recent Watch Sessions</span>
                </div>
                <div class="table-container">
                    <table id="sessions-table">
                        <thead>
                            <tr>
                                <th>Started</th>
                                <th>File</th>
                                <th>Duration</th>
                                <th>Cell</th>
                                <th>Path</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Grid Sessions -->
        <div class="section">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Grid Sessions</span>
                </div>
                <div class="table-container">
                    <table id="grid-sessions-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Action</th>
                                <th>Grid</th>
                                <th>Source</th>
                                <th>Filter</th>
                                <th>Path</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let hourlyChart, dailyChart, timelineChart, fileTypeChart, skipHeatmapChart, skipTypesChart, sessionDistChart, weeklyTrendChart, monthlyTrendChart;

        const chartColors = {
            accent: '#00d4ff',
            accentDim: 'rgba(0, 212, 255, 0.3)',
            success: '#00ff88',
            successDim: 'rgba(0, 255, 136, 0.3)',
            grid: 'rgba(255, 255, 255, 0.05)',
            text: '#a0a0b0'
        };

        async function fetchData(endpoint) {
            const response = await fetch(`/api/${endpoint}`);
            return response.json();
        }

        async function loadSummary() {
            const data = await fetchData('summary');

            document.getElementById('real-time').textContent = data.real_elapsed_time;
            document.getElementById('accumulated-time').textContent = data.accumulated_watch_time;
            document.getElementById('parallelism').textContent = data.parallelism_factor + 'x';
            document.getElementById('files-tracked').textContent = data.files_tracked;

            document.getElementById('today-real').textContent = data.today_real_time;
            document.getElementById('today-accumulated').textContent = data.today_accumulated_time;
            document.getElementById('today-sessions').textContent = data.today_sessions;
            document.getElementById('avg-session').textContent = data.avg_session_length;

            document.getElementById('peak-hour').textContent = data.peak_hour;
            document.getElementById('peak-day').textContent = data.peak_day;
            document.getElementById('total-skips').textContent = data.total_skips;
            document.getElementById('total-screenshots').textContent = data.total_screenshots;
        }

        async function loadHourlyChart() {
            const data = await fetchData('hourly');

            if (hourlyChart) hourlyChart.destroy();

            hourlyChart = new Chart(document.getElementById('hourlyChart'), {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Watch Time (min)',
                        data: data.watch_time,
                        backgroundColor: chartColors.accentDim,
                        borderColor: chartColors.accent,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        },
                        y: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        }
                    }
                }
            });
        }

        async function loadDailyChart() {
            const data = await fetchData('daily');

            if (dailyChart) dailyChart.destroy();

            dailyChart = new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Watch Time (min)',
                        data: data.watch_time,
                        backgroundColor: chartColors.successDim,
                        borderColor: chartColors.success,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        },
                        y: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        }
                    }
                }
            });
        }

        async function loadTimelineChart() {
            const data = await fetchData('timeline');

            if (timelineChart) timelineChart.destroy();

            timelineChart = new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Real Time (min)',
                            data: data.map(d => d.real_minutes),
                            borderColor: chartColors.accent,
                            backgroundColor: chartColors.accentDim,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Accumulated (min)',
                            data: data.map(d => d.accumulated_minutes),
                            borderColor: chartColors.success,
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: chartColors.text }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        },
                        y: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        }
                    }
                }
            });
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.classList.remove('copied');
                }, 1500);
            });
        }

        async function openInFileManager(path) {
            try {
                const response = await fetch('/api/open-folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`Opened: ${data.folder}`);
                } else {
                    showToast(`Error: ${data.error}`);
                }
            } catch (e) {
                showToast(`Failed to open folder: ${e.message}`);
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        async function loadCompletionStats() {
            const data = await fetchData('completion-stats');
            document.getElementById('full-watch').textContent = data.full_watch_count;
            document.getElementById('partial-watch').textContent = data.partial_watch_count;
            document.getElementById('skipped-files').textContent = data.skipped_count;
            document.getElementById('avg-completion').textContent = data.average_completion + '%';
        }

        async function loadFileTypeBreakdown() {
            const data = await fetchData('file-type-breakdown');

            document.getElementById('video-time').textContent = data.video_time;
            document.getElementById('video-count').textContent = data.video_count;
            document.getElementById('image-time').textContent = data.image_time;
            document.getElementById('image-count').textContent = data.image_count;

            if (fileTypeChart) fileTypeChart.destroy();

            fileTypeChart = new Chart(document.getElementById('fileTypeChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Videos', 'Images'],
                    datasets: [{
                        data: [data.video_ms, data.image_ms],
                        backgroundColor: [chartColors.success, chartColors.accent],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: chartColors.text }
                        }
                    }
                }
            });
        }

        async function loadConcurrentStats() {
            const data = await fetchData('concurrent-stats');
            document.getElementById('avg-concurrent').textContent = data.average_concurrent + 'x';

            const tbody = document.querySelector('#cell-usage-table tbody');
            tbody.innerHTML = data.cell_usage.map(c => `
                <tr>
                    <td>${c.cell}</td>
                    <td>${c.sessions}</td>
                    <td>${c.watch_time}</td>
                </tr>
            `).join('');
        }

        async function loadSkipHeatmap() {
            const data = await fetchData('skip-heatmap');

            if (skipHeatmapChart) skipHeatmapChart.destroy();

            skipHeatmapChart = new Chart(document.getElementById('skipHeatmapChart'), {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Skips at Position',
                        data: data.values,
                        backgroundColor: 'rgba(255, 170, 0, 0.5)',
                        borderColor: '#ffaa00',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Where in videos do you skip most?',
                            color: chartColors.text
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text },
                            title: { display: true, text: 'Video Position', color: chartColors.text }
                        },
                        y: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text },
                            title: { display: true, text: 'Skip Count', color: chartColors.text }
                        }
                    }
                }
            });
        }

        async function loadSkipTypes() {
            const data = await fetchData('skip-types');

            if (skipTypesChart) skipTypesChart.destroy();

            const labels = Object.keys(data);
            const values = Object.values(data);
            const colors = ['#ff4466', '#ffaa00', '#00d4ff', '#00ff88', '#9966ff', '#ff66aa'];

            skipTypesChart = new Chart(document.getElementById('skipTypesChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: chartColors.text }
                        }
                    }
                }
            });
        }

        async function loadSessionDistribution() {
            const data = await fetchData('session-distribution');

            if (sessionDistChart) sessionDistChart.destroy();

            sessionDistChart = new Chart(document.getElementById('sessionDistChart'), {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Sessions',
                        data: data.values,
                        backgroundColor: chartColors.accentDim,
                        borderColor: chartColors.accent,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        },
                        y: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        }
                    }
                }
            });
        }

        async function loadWeeklyTrend() {
            const data = await fetchData('weekly-trend?weeks=12');

            if (weeklyTrendChart) weeklyTrendChart.destroy();

            weeklyTrendChart = new Chart(document.getElementById('weeklyTrendChart'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.week),
                    datasets: [{
                        label: 'Watch Time (min)',
                        data: data.map(d => d.minutes),
                        borderColor: chartColors.accent,
                        backgroundColor: chartColors.accentDim,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        },
                        y: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        }
                    }
                }
            });
        }

        async function loadMonthlyTrend() {
            const data = await fetchData('monthly-trend?months=12');

            if (monthlyTrendChart) monthlyTrendChart.destroy();

            monthlyTrendChart = new Chart(document.getElementById('monthlyTrendChart'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Watch Time (min)',
                        data: data.map(d => d.minutes),
                        backgroundColor: chartColors.successDim,
                        borderColor: chartColors.success,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        },
                        y: {
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        }
                    }
                }
            });
        }

        async function loadFavorites() {
            const data = await fetchData('favorites');
            const tbody = document.querySelector('#favorites-table tbody');
            const noFavs = document.getElementById('no-favorites');

            if (data.length === 0) {
                tbody.innerHTML = '';
                noFavs.style.display = 'block';
            } else {
                noFavs.style.display = 'none';
                tbody.innerHTML = data.map(f => `
                    <tr>
                        <td class="file-name" title="${f.path}">${f.file}</td>
                        <td>${f.watch_time}</td>
                        <td>${f.play_count}</td>
                        <td><span class="badge ${f.is_image ? 'badge-image' : 'badge-video'}">${f.is_image ? 'IMG' : 'VID'}</span></td>
                        <td>${f.added_at}</td>
                        <td class="path-cell">
                            <span class="path-text" title="${f.path}">${f.path}</span>
                            <button class="copy-btn" onclick="copyToClipboard('${f.path.replace(/'/g, "\\'")}', this)">Copy</button>
                            <button class="open-btn" onclick="openInFileManager('${f.path.replace(/'/g, "\\'")}')">Open</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function loadTopFiles() {
            const data = await fetchData('top-files?limit=15');
            const tbody = document.querySelector('#top-files-table tbody');
            tbody.innerHTML = data.map((f, i) => `
                <tr>
                    <td class="file-name" title="${f.path}">${f.file}</td>
                    <td>${f.watch_time}</td>
                    <td>${f.play_count}</td>
                    <td>${f.skip_count}</td>
                    <td>${f.loop_count}</td>
                    <td>${f.avg_watch_pct}%</td>
                    <td><span class="badge ${f.is_image ? 'badge-image' : 'badge-video'}">${f.is_image ? 'IMG' : 'VID'}</span></td>
                    <td class="path-cell">
                        <span class="path-text" title="${f.path}">${f.path}</span>
                        <button class="copy-btn" onclick="copyToClipboard('${f.path.replace(/'/g, "\\'")}', this)">Copy</button>
                        <button class="open-btn" onclick="openInFileManager('${f.path.replace(/'/g, "\\'")}')">Open</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadDirectories() {
            const data = await fetchData('directories');
            const tbody = document.querySelector('#directories-table tbody');
            tbody.innerHTML = data.map(d => `
                <tr>
                    <td class="file-name" title="${d.directory}">${d.short_name}</td>
                    <td>${d.watch_time}</td>
                    <td>${d.file_count}</td>
                    <td class="path-cell">
                        <button class="copy-btn" onclick="copyToClipboard('${d.directory.replace(/'/g, "\\'")}', this)">Copy</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadRecentSessions() {
            const data = await fetchData('recent-sessions?limit=20');
            const tbody = document.querySelector('#sessions-table tbody');
            tbody.innerHTML = data.map(s => `
                <tr>
                    <td>${s.started}</td>
                    <td class="file-name" title="${s.path}">${s.file}</td>
                    <td>${s.duration}</td>
                    <td>${s.cell}</td>
                    <td class="path-cell">
                        <span class="path-text" title="${s.path}">${s.path}</span>
                        <button class="copy-btn" onclick="copyToClipboard('${s.path.replace(/'/g, "\\'")}', this)">Copy</button>
                        <button class="open-btn" onclick="openInFileManager('${s.path.replace(/'/g, "\\'")}')">Open</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadGridSessions() {
            const data = await fetchData('grid-sessions');
            const tbody = document.querySelector('#grid-sessions-table tbody');
            tbody.innerHTML = data.map(s => `
                <tr class="${s.action === 'Started' ? 'highlight-row' : ''}">
                    <td>${s.time}</td>
                    <td>${s.action}</td>
                    <td>${s.grid}</td>
                    <td class="file-name">${s.source}</td>
                    <td>${s.filter}</td>
                    <td class="path-cell">
                        ${s.source !== '-' ? `<button class="copy-btn" onclick="copyToClipboard('${s.source.replace(/'/g, "\\'")}', this)">Copy</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        async function refreshAll() {
            await Promise.all([
                loadSummary(),
                loadHourlyChart(),
                loadDailyChart(),
                loadTimelineChart(),
                loadCompletionStats(),
                loadFileTypeBreakdown(),
                loadConcurrentStats(),
                loadSkipHeatmap(),
                loadSkipTypes(),
                loadSessionDistribution(),
                loadWeeklyTrend(),
                loadMonthlyTrend(),
                loadFavorites(),
                loadTopFiles(),
                loadDirectories(),
                loadRecentSessions(),
                loadGridSessions()
            ]);
        }

        // Initial load
        refreshAll();

        // Auto-refresh every 30 seconds
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>
